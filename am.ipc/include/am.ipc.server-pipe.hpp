#ifndef AM_IPC_NEW_PIPE_H
#define AM_IPC_NEW_PIPE_H

#include "am.ipc.base-pipe.hpp"

namespace ipc {
	// Class of Server Pipe creating by owner process
	class IPC_LIB_API ServerPipe: public BasePipe {
	private:
		bool _listenFlag;

		// Restriction copying of pipes
		explicit ServerPipe() noexcept { }
		explicit ServerPipe(const ServerPipe&) noexcept { }
		void operator=(const ServerPipe&) noexcept { }

		// Function for a detached thread listening to connections
		static void WaitConnection(ServerPipe*) noexcept;

		// Create event private function
		void CreateEv(HANDLE&, const tchar* const) noexcept(false);

	public:
		// Constructor
		explicit ServerPipe(const tchar* const, const uint) noexcept(false);

		// Destructor
		~ServerPipe() noexcept(false);

		// Pipe is listen requests for connection
		void ListenCons() noexcept;

		// Pipe stop listening requests for connection (except the last one)
		void StopListenCons() noexcept;

		// Send message (response) from owner pipe class
		void SendMsg(DWORD) noexcept(false) override;

		// Read message (request) from pipe by owner
		DWORD GetMsg() noexcept(false);

		// Is are incoming message for pipe owner?
		virtual bool IsIncomingMsg() noexcept(false) override;

		// Pipe owner process waits until a message is sent to him
		virtual void WaitIncomingMsg() noexcept(false) override;
	};

	// Fabric for Server Pipes
	IPC_LIB_API std::shared_ptr<ServerPipe> CreateServerPipe(const tchar* const, const uint) noexcept;

}

#endif // AM_IPC_NEW_PIPE_H
