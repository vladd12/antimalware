#include "../include/am.ipc.pipe.hpp"

using namespace IPC;

// Constructor
Pipe::Pipe(const tchar* const pipeName, const uint bufSize) throw (...):
	_hPipe(INVALID_HANDLE_VALUE), _bufSize(bufSize)
{
	// Creation pipe
	_hPipe = CreateNamedPipe(pipeName, PIPE_ACCESS_DUPLEX,
		PIPE_TYPE_MESSAGE | PIPE_READMODE_MESSAGE | PIPE_WAIT,
		PIPE_UNLIMITED_INSTANCES, bufSize, bufSize, 0, NULL);
	// If creation failed
	if (_hPipe == INVALID_HANDLE_VALUE) {
		std::runtime_error("Failed creation of pipe");
	}
}

// Destructor
Pipe::~Pipe() throw (...) {
	if (CloseHandle(_hPipe) != TRUE) {
		std::runtime_error("Failed closing handle of pipe");
	}
}

// t3
std::shared_ptr<Pipe> CreatePipe(const tchar* const pipeName, const uint& bufSize) {
	return std::make_shared<Pipe>(pipeName, bufSize);
}
