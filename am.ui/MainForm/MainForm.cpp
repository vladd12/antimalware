#include <string>
#include <Windows.h>
#include "MainForm.h"

namespace am_ui {
	/* ------- Function prototypes ------ */
	// Print message about scanned file in TextBox
	void OutputFileStatus(ipc::FileStat& fStat, RichTextBox^ output, OutputStrDelegate^ del);
	// Print message about scanning status in TextBox
	void OutputScanningStatus(ipc::ScanningStat& scStat, RichTextBox^ output);
	// // Call invoke delegate "Deactivate UI"
	void DeactivateUI(DeactivateUIDel^ deactivator, MainForm^ form);
	// // Call invoke delegate "Activate UI"
	void ActivateUI(ActivateUIDel^ activator, MainForm^ form);
	/* --- End of function prototypes --- */

	// MainForm constructor
	MainForm::MainForm(void) {
		InitializeComponent();
		using System::Collections::Generic::List;
		using namespace core;
		using namespace ipc;
		// Set list of items for cbChsCtrlAction [comboBox]
		CtrlActions = gcnew List<ControlActionItem^>();
		CtrlActions->Add(gcnew ControlActionItem(ControlMessage::Start, "Start Service"));
		CtrlActions->Add(gcnew ControlActionItem(ControlMessage::Stop, "Stop Service"));
		CtrlActions->Add(gcnew ControlActionItem(ControlMessage::Shutdown, "Shutdown Service"));
		cbChsCtrlAction->DisplayMember = "ActionName";
		cbChsCtrlAction->ValueMember = "ActionType";
		cbChsCtrlAction->DataSource = CtrlActions;
		cbChsCtrlAction->SelectedIndex = 0;

		// Set list of items for cbChsDtctAction [comboBox]
		DtctActions = gcnew List<DetectionActionItem^>();
		DtctActions->Add(gcnew DetectionActionItem(DetectAction::Remove, "Remove files"));
		DtctActions->Add(gcnew DetectionActionItem(DetectAction::Replace, "Replace files to quarantine folder"));
		cbChsDtctAction->DisplayMember = "ActionName";
		cbChsDtctAction->ValueMember = "ActionType";
		cbChsDtctAction->DataSource = DtctActions;
		cbChsDtctAction->SelectedIndex = 0;

		// Create client pipes
		UIPipe = new ClientPipe;
		ccm = new ClientConnectionManager;
		*UIPipe = ccm->GetConnection();
		if (UIPipe->GetHandle() == INVALID_HANDLE_VALUE) {
			RealoadService();
		}

		// Create delegates
		TextPrinter = gcnew OutputStrDelegate(this, &MainForm::OutputText);
		D_UI_Del = gcnew DeactivateUIDel(this, &MainForm::DeactivateBtns);
		A_UI_Del = gcnew ActivateUIDel(this, &MainForm::ActivateBtns);
	}

	// Destructor
	MainForm::~MainForm() {
		if (components) delete components;
		StateRead = false;
		Sleep(101);
		delete UIPipe;
		// delete WDPipe;
		delete tracer;
	}

	// Reloading service
	void MainForm::RealoadService() {
		system("am.ams.exe --run");
		Sleep(50);
		*UIPipe = ccm->GetConnection();
	}

	// Button send control message to service
	void MainForm::bCtrlAction_Click(System::Object^ sender, System::EventArgs^ e) {
		// Get ctrl msg from combo box and pack it in message holder
		ipc::ControlMessage action = safe_cast<core::ControlActionItem^>(cbChsCtrlAction->SelectedItem)->ActionType;
		ipc::MessageHolder buffer;
		buffer.Pack(action);
		buffer.mType = ipc::MessageType::CtrlMessage;
		// Send data or rerun service
		switch (action) {
		case ipc::ControlMessage::Start:
			lblText->Text = "Start";
			RealoadService();
			break;
		case ipc::ControlMessage::Stop:
			lblText->Text = "Stop";
			SendData(buffer);
			break;
		case ipc::ControlMessage::Shutdown:
			lblText->Text = "Shutdown";
			SendData(buffer);
			break;
		}
	}

	// Button for full scanning was pressed
	void MainForm::btnFullScan_Click(System::Object^ sender, System::EventArgs^ e) {
		tBoxOutput->Text = L"";
		const DWORD dwSize = MAX_PATH;
		char szLogicalDrives[dwSize] = { 0 };
		std::string result = "";
		// Get all logical drives
		DWORD dwResult = GetLogicalDriveStringsA(dwSize, szLogicalDrives);
		if (dwResult > 0 && dwResult <= MAX_PATH) {
			char* szSingleDrive = szLogicalDrives;
			while (*szSingleDrive) {
				result += std::string(szSingleDrive) + ';';
				// Get the next drive
				szSingleDrive += strlen(szSingleDrive) + 1;
			}
		}
		ipc::TasksContainer tCont;
		tCont.dAction = GetDetectAction();
		memcpy_s(&tCont.unformString, 1016, result.c_str(), result.length() + 1);
		ipc::MessageHolder msg(tCont);
		msg.mType = ipc::MessageType::Task;
		SendData(msg);
	}

	// Button for fast scanning was pressed
	void MainForm::btnFastScan_Click(System::Object^ sender, System::EventArgs^ e) {
		tBoxOutput->Text = L"";
		//std::string task("C:\\Windows\\System32");
		std::string task("E:\\Games\\OMORI");
		ipc::TasksContainer tCont;
		tCont.dAction = GetDetectAction();
		memcpy_s(&tCont.unformString, 1016, task.c_str(), task.length() + 1);
		ipc::MessageHolder msg(tCont);
		msg.mType = ipc::MessageType::Task;
		SendData(msg);
	}

	// Button for selective scanning was pressed
	void MainForm::btnChooseScan_Click(System::Object^ sender, System::EventArgs^ e) {
		InputForm^ in_form = gcnew InputForm(this);
		in_form->Show();
		in_form->Visible = true;
	}

	// Function for transfering data between main form and input form
	void MainForm::SendChoosenTasks(const char* tasks, std::size_t s_len) {
		tBoxOutput->Text = L"";
		ipc::TasksContainer tCont;
		tCont.dAction = GetDetectAction();
		memcpy_s(&tCont.unformString, 1016, tasks, s_len + 1);
		ipc::MessageHolder msg(tCont);
		msg.mType = ipc::MessageType::Task;
		SendData(msg);
	}

	// Sends message from client pipe
	void MainForm::SendData(ipc::MessageHolder& msg) {
		using namespace System::Threading;
		if (!UIPipe->Send(msg)) {
			RealoadService();
		}
		// Create reader thread
		Reader = gcnew Thread(gcnew ParameterizedThreadStart(&ReaderProcess));
		Reader->Start(this);
	}

	// Function for reader thread
	void MainForm::ReaderProcess(Object^ obj) {
		auto mf = safe_cast<MainForm^>(obj);
		bool stateReading = true;
		ipc::FileStat fStat;
		ipc::ScanningStat scStat;
		DeactivateUI(mf->D_UI_Del, mf);
		while (stateReading) {
			auto msg(mf->UIPipe->Read());
			switch (msg.mType) {
			case ipc::MessageType::FileStatus:
				fStat = msg.Unpack<ipc::FileStat>();
				OutputFileStatus(fStat, mf->tBoxOutput, mf->TextPrinter);
				break;
			case ipc::MessageType::ScanningStatus:
				scStat = msg.Unpack<ipc::ScanningStat>();
				if (scStat == ipc::ScanningStat::Ended) stateReading = false;
				break;
			// error occurs
			case ipc::MessageType::None:
				stateReading = false;
				mf->RealoadService();
				break;
			}
		}
		ActivateUI(mf->A_UI_Del, mf);
	}

	// Print message about scanned file in TextBox
	void OutputFileStatus(ipc::FileStat& fStat, RichTextBox^ output, OutputStrDelegate^ del) {
		if (fStat.isInfected) {
			String^ msg = gcnew String(fStat.filePath) 
				+ " is infected. Malware's name: " + gcnew String(fStat.signatureName)
				+ ". Position in file: " + fStat.pos + "\n";
			output->Invoke(del, msg);
		}
		else {
			String^ msg = gcnew String(fStat.filePath) + " is clear.\n";
			output->Invoke(del, msg);
		}
	}

	// Print message about scanning status in TextBox
	void OutputScanningStatus(ipc::ScanningStat& scStat, RichTextBox^ output) {
		// TODO: just do it
	}

	// Output messages from server
	void MainForm::OutputText(String^ text) {
		tBoxOutput->Text = tBoxOutput->Text + text;
	}

	// Returns DetectAction from selected item on form
	ipc::DetectAction MainForm::GetDetectAction() {
		ipc::DetectAction action = safe_cast<core::DetectionActionItem^>(cbChsDtctAction->SelectedItem)->ActionType;
		return action;
	}

	// Mode form "deactivate UI"
	void MainForm::DeactivateBtns(Void) {
		btnFullScan->Enabled = false;
		btnFastScan->Enabled = false;
		btnChooseScan->Enabled = false;
		btnResume->Enabled = true;
		btnPause->Enabled = true;
		btnStop->Enabled = true;
	}

	// Mode form "activate UI"
	void MainForm::ActivateBtns(Void) {
		btnFullScan->Enabled = true;
		btnFastScan->Enabled = true;
		btnChooseScan->Enabled = true;
		btnResume->Enabled = false;
		btnPause->Enabled = false;
		btnStop->Enabled = false;
	}

	// Call invoke delegate "DeactivateUI"
	void DeactivateUI(DeactivateUIDel^ deactivator, MainForm^ form) {
		form->Invoke(deactivator);
	}

	// Call invoke delegate "ActivateUI"
	void ActivateUI(ActivateUIDel^ activator, MainForm^ form) {
		form->Invoke(activator);
	}

}
