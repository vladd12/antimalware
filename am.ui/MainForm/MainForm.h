#ifndef AM_UI_MAIN_FORM_H
#define AM_UI_MAIN_FORM_H

#include "am.ipc.ccm.hpp"
#include "../core/basic_structures.hpp"
#include "../InputForm/InputForm.h"

namespace am_ui {
	using namespace System;
	using namespace System::ComponentModel;
	using namespace System::Collections;
	using namespace System::Windows::Forms;
	using namespace System::Data;
	using namespace System::Drawing;

	// Delegates definition
	//
	public delegate void OutputStrDelegate(String^ str);
	public delegate void DeactivateUIDel(Void);
	public delegate void ActivateUIDel(Void);

	// Main form class
	public ref class MainForm : public System::Windows::Forms::Form {
	public:
		// Constructor
		MainForm(void);

	protected:
		// Destructor
		~MainForm();

	private:
		System::Collections::Generic::List<core::ControlActionItem^>^ CtrlActions;
		System::Collections::Generic::List<core::DetectionActionItem^>^ DtctActions;
		ipc::ClientConnectionManager* ccm;
		ipc::ClientPipe* UIPipe;
		ipc::ClientPipe* WDPipe;
		trace::LogTracer* tracer;
		bool StateRead;
		static System::Threading::Mutex^ PipeLocker;
		System::Threading::Thread^ Reader;
		OutputStrDelegate^ TextPrinter;
		DeactivateUIDel^ D_UI_Del;
		ActivateUIDel^ A_UI_Del;
		HANDLE evSync;

	private: System::ComponentModel::Container^ components;
	private: System::Windows::Forms::Button^  bCtrlAction;
	private: System::Windows::Forms::Label^  lblText;
	private: System::Windows::Forms::TabControl^  tabZone;
	private: System::Windows::Forms::TabPage^  tabScan;
	private: System::Windows::Forms::TabPage^  tabPreferences;
	private: System::Windows::Forms::Label^  lblScan;
	private: System::Windows::Forms::Button^  btnFullScan;
	private: System::Windows::Forms::Button^  btnFastScan;
	private: System::Windows::Forms::Button^  btnChooseScan;
	private: System::Windows::Forms::Button^  btnResume;
	private: System::Windows::Forms::Button^  btnPause;
	private: System::Windows::Forms::Button^  btnStop;
	private: System::Windows::Forms::RichTextBox^  tBoxOutput;
	private: System::Windows::Forms::Label^  lblDtctActType;
	private: System::Windows::Forms::Label^  lblCtrlMsgType;
	private: System::Windows::Forms::ComboBox^  cbChsDtctAction;
	private: System::Windows::Forms::ComboBox^  cbChsCtrlAction;

	public:
		// Function for transfering data between main form and input form
		void SendChoosenTasks(const char* tasks, std::size_t s_len);

	private:
		// Render form's components
		void InitializeComponent(void);

		// Button send control message to service
		void bCtrlAction_Click(System::Object^ sender, System::EventArgs^ e);

		// Function for reader thread
		static void ReaderProcess(Object^ obj);

		// Button for full scanning was pressed
		void btnFullScan_Click(System::Object^ sender, System::EventArgs^ e);

		// Button for fast scanning was pressed
		void btnFastScan_Click(System::Object^ sender, System::EventArgs^ e);

		// Button for selective scanning was pressed
		void btnChooseScan_Click(System::Object^ sender, System::EventArgs^ e);

		// Returns DetectAction from selected item on form
		ipc::DetectAction GetDetectAction();

		// Reloading service
		void RealoadService();

		// Sends message from client pipe
		void SendData(ipc::MessageHolder& msg);
		
		// Output messages from server
		void OutputText(String^ text);

		// Mode form "deactivate UI"
		void DeactivateBtns(Void);

		// Mode form "activate UI"
		void ActivateBtns(Void);
		
		// Button for resuming scan was pressed
		void btnResume_Click(System::Object^ sender, System::EventArgs^ e);

		// Button for pausing scan was pressed
		void btnPause_Click(System::Object^ sender, System::EventArgs^ e);

		// Button for stopping scan was pressed
		void btnStop_Click(System::Object^ sender, System::EventArgs^ e);

	};

}

#endif // AM_UI_MAIN_FORM_H
