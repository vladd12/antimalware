#include "../include/am.slib.tracer.hpp"

namespace slib {
	// Constructor with selecting output system (console/windows)
	TracerW::TracerW(OutputLevel&& _outLvl):
		info(nullptr), warn(nullptr), err(nullptr),
		wnd(nullptr), outLvl(_outLvl), lastTrLvl(TraceLevel::Info)
	{
		if (outLvl == OutputLevel::Console) {
			info = &std::wcout;
			warn = &std::wcout;
			err = &std::wcerr;
		}
		else if (outLvl == OutputLevel::Window) {
			wnd = new std::wostringstream();
			err = warn = info = reinterpret_cast<std::wostream*>(wnd);
		}
	}

	// Constructor with passing a referenceû to output streams 
	// (each stream is trace level)
	TracerW::TracerW(std::wostream& _info, std::wostream& _warn, std::wostream& _err):
		info(&_info), warn(&_warn), err(&_err), wnd(nullptr),
		outLvl(OutputLevel::Console), lastTrLvl(TraceLevel::Info) { }

	// Destructor
	TracerW::~TracerW() {
		if (outLvl == OutputLevel::Window) delete wnd;
	}

	// Tracer returns a stream for the specified trace level
	std::wostream& TracerW::Trace(TraceLevel&& traceLvl) throw (...) {
		lastTrLvl = traceLvl;
		switch (lastTrLvl) {
		case TraceLevel::Info:
			return *info;
		case TraceLevel::Warning:
			return *warn;
		case TraceLevel::Error:
			return *err;
		default:
			throw std::runtime_error("Undefined Trace Level");
		}
	}

	// Show trace string in message box (special for Windos output model)
	void TracerW::ShowTrace(void) throw(...) {
		if (outLvl == OutputLevel::Window) {
			LPWSTR trLvlStr;
			UINT msgType;
			switch (lastTrLvl) {
			case TraceLevel::Info:
				trLvlStr = L"Info";
				msgType = MB_ICONINFORMATION;
				break;
			case TraceLevel::Warning:
				trLvlStr = L"Warning";
				msgType = MB_ICONWARNING;
				break;
			case TraceLevel::Error:
				trLvlStr = L"Error";
				msgType = MB_ICONERROR;
				break;
			default:
				throw std::runtime_error("Undefined Trace Level");
			}
			MessageBoxW(NULL, (*wnd).str().c_str(), const_cast<LPCWSTR>(trLvlStr), msgType);
		}
		else *warn << L"Trying show trace for message box in console output mode.\n";
	}

}
