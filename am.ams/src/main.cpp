#include <tchar.h>
#include "../include/am.ams.service.hpp"
#include "am.trace.log-tracer.hpp"
#include "am.slib.sm.hpp"

int _tmain(int argc, TCHAR* argv[]) {
	using trace::LogTracer;
	using slib::ServiceManager;
	const char* pathLogFile = "E:\\Log.txt";

	// If process run from Sevice Control Manager
	if (argc - 1 == 0) {
		auto tracer = std::make_shared<LogTracer>(pathLogFile);
		ams::AntimalwareServiceFactory serviceFactory(tracer);
		InitService(tracer, serviceFactory);
	}
	// If process run by user from console
	else {
		LogTracer tracer(pathLogFile);
		ServiceManager sm { tracer, L"AntimalwareService", argv[0] };
		if (_tcscmp(argv[argc - 1], TEXT("--install")) == 0) {
			sm.InstallService();
		}
		else if (_tcscmp(argv[argc - 1], TEXT("--uninstall")) == 0) {
			sm.UninstallService();
		}
		else if (_tcscmp(argv[argc - 1], TEXT("--run")) == 0) {
			sm.RunService();
		}
	}
	return 0;
}
