#ifndef AM_DB_DBFILE_H
#define AM_DB_DBFILE_H

#include <fstream>
#include <iostream>
#include "am.db.structures.hpp"

namespace db {
	// Check existing file (ASCII)
	bool IsFileExistA(LPCSTR FileName);

	// Check existing file (Unicode)
	bool IsFileExistW(LPCWSTR FileName);

	// Unicode defines
	#ifdef UNICODE
	#define IsFileExist IsFileExistW
	#else
	#define IsFileExist IsFileExistA
	#endif

	// Database of signatures class
	class DBFile {
	protected:
		std::fstream hFile;  // File stream
		uint32_t RecordCount;   // Num of records in database
		const char* DBSignature;  // DB file signature

		// Virtual
		virtual bool Open(PCWSTR filePath) = 0;

	public:
		// Constructor
		DBFile() noexcept;

		// Checking state of file stream
		virtual bool IsOpen() noexcept;

		// Closing file stream
		virtual void CloseFile() noexcept;

		// Getting count of records in database
		virtual uint32_t GetRecordCount() noexcept;

	};

	// Class for writing records in database file
	class DBFileWriter: public DBFile {
	private:
		// Opening file
		virtual bool Open(PCWSTR filePath) override;

		// Get record from request
		Record GetRecord(PCWSTR filePath, PCSTR sigName, uint32_t& offset, uint32_t& length, SignatureRange& range);

	public:
		// Delete default constructor
		DBFileWriter() noexcept = delete;

		// Constructor for wide string
		DBFileWriter(PCWSTR filePath) noexcept(false);

		// Constructor for ASCII string
		DBFileWriter(PCSTR filePath) noexcept(false);

		// Add record in database file
		bool AddRecord(Record& record);

		// Add record in database from file
		bool AddRecord(PCWSTR filePath, PCSTR sigName, uint32_t offset, uint32_t length, SignatureRange range);

		// Add record in database from file
		bool AddRecord(PCSTR filePath, PCSTR sigName, uint32_t offset, uint32_t length, SignatureRange range);
		
	};

	// Class for reading records from database file
	class DBFileReader: public DBFile {
	private:
		// Opening file
		virtual bool Open(PCWSTR filePath) override;

	public:
		// Delete default constructor
		DBFileReader() noexcept = delete;

		// Constructor for wide string
		DBFileReader(PCWSTR filePath) noexcept(false);

		// Constructor for ASCII string
		DBFileReader(PCSTR filePath) noexcept(false);

		// Read record from database
		bool ReadNextRecord(Record* record);
		
	};

}

#endif // AM_DB_DBFILE_H
